### 5.2.2  IPv4地址
<!-- 本部分内容基于 [IPv4地址](https://en.wikipedia.org/wiki/IPv4) 条目（CC BY-SA 4.0）改编 -->

<details><summary><font size="5"> IPv4地址 </summary>
  
| 描述 | A类IPv4地址 | B类IPv4地址 | C类IPv4地址 | D类IPv4地址 | E类IPv4地址 |
|:---|:---|:---|:---|:---|:---|
| 网络标志位 | 0 | 10 | 110 | 1110 | 1111 |
| IP地址范围 | 0.0.0.0~127.255.255.255 | 128.0.0.0~191.255.255.255 | 192.0.0.0~223.255.255.255 | 224.0.0.0~239.255.255.255 | 240.0.0.0~255.255.255.255 |
| 可用IP地址范围 | 1.0.0.1~127.255.255.254 | 128.0.0.1~191.255.255.254 | 192.0.0.1~223.255.255.254 |  |  |
| 是否可以分配给主机使用 | 是 | 是 | 是 | 否 | 否 |
| 网络数量（个） | 126 (2⁷-2) | 16384 (2¹⁴) | 2097152 (2²¹) | --- | --- |
| 每个网络中可容纳主机数（个） | 16777214 (2²⁴-2) | 65534 (2¹⁶-2) | 254 (2⁸-2) | --- | --- |
| 适用范围 | 大量主机的大型网络 | 中等规模主机数的网络 | 小型局域网 | [多播](https://zh.wikipedia.org/wiki/%E5%A4%9A%E6%92%AD)地址 | 保留，仅作为搜索、Internet的实验和开发用 |
| 备注 | 0.0.0.0为特殊地址，表示本网主机 |  |  |  | 255.255.255.255为特殊地址，用于[定向广播](https://zh.wikipedia.org/wiki/%E5%BB%A3%E6%92%AD_(%E7%B6%B2%E8%B7%AF)) |

</details>
<details><summary><font size="5"> 子网掩码 </summary>

- **子网掩码**是一个 32 位的二进制序列，用于屏蔽 IP 地址的一部分以区别网络地址和主机地址。
- **逻辑运算**：网络设备将目标 IP 地址与子网掩码进行逻辑 “与”（AND） 运算，从而提取出目标网络地址。
> - 结构演变：
> - 两级结构：网络号 + 主机号。
> - 三级结构：网络号 + *子网号* + 主机号

#### 子网划分的计算
- 子网掩码中的 ***1*** 代表网络/子网部分，***0*** 代表主机部分
> - B 类地址示例：标准掩码为 255.255.0.0
> - 若将其划分为子网，会将主机位的高位“借”给子网位
- 计算公式：可分配的主机数量为 $2^M - 2$（ $M$ 为主机位位数，减去的是网络地址和广播地址）

#### VLSM（可变长子网掩码）
- 为了解决传统划分导致地址浪费的问题，引入了**VLSM**：
- 核心思想：在一个组织内部，根据不同子网的大小需求，使用不同长度的掩码
- 表示法：通常在 IP 地址后加 /n，其中 $n$ 是掩码中 1 的个数（如 /24 对应 255.255.255.0）

</details>

### 5.2.3 IPv4协议的操作

  <details><summary><font size="5"> 1）数据报生存期（TTL）</summary>
 
- **定义**：IP报文头中的一个8位字段，取值范围0-255
- **作用**：防止数据报在网络中无限循环
- **工作机制**：
  - 源端设置初始TTL值（不同操作系统有默认值，如64、128、255）
  - 每经过一个路由器（一跳），TTL值减1
  - 当TTL减到0时，路由器丢弃该报文，并向源端发送ICMP超时消息（Type 11）
- **扩展用途**：可通过TTL值推测目标主机距离（[traceroute原理](https://zh.wikipedia.org/wiki/Traceroute)）
  </details>
  <details><summary><font size="5"> 2）分段和重装配</summary>

> 当IP数据报长度超过网络MTU（最大传输单元）时，需要将其分成若干较小的片段进行传输，这个过程称为分片。<br>目标端收到所有分片后，再重新组装成原始数据报

***分片规则***
- **分片长度**：除最后一个分片外，每个分片的长度必须是 8字节的整数倍（因为片偏移字段以8字节为单位）。
***分片过程***：
- 对每一分段加上原数据报的IP头，组成新的短报文
- 每个短报文的总长度字段置为它包含的字节数
- 每个分片的片偏移 = 该分片在原数据报中的起始位置（字节数）÷ 8
- M标志（更多分片）：最后一个分片置为0，其他分片置为1


|项目|长度（字节）|片偏移（单位：8字节）|M标志|
|---|---|---|---|
|原数据报|475|—|—|
|第一个分片|240|0|1|
|第二个分片|235|30|0|
> **计算说明**：<br>第一个分片240字节，片偏移0，<br>M=1表示后面还有分片；<br>第二个分片235字节，<br>片偏移=240/8=30，M=0表示最后一个分片。

***重装配（重组）***
- **条件**：以片偏移为0的分片开始，以M标志为0的分片结束，且所有分片必须具有相同的标识符（ID）
- **超时机制**：防止因分片丢失导致无限等待
  - 目标站设置本地时钟，第一个分片到达时启动重装配定时器
  - 若定时器超时仍未收齐所有分片，则放弃本次重装配，丢弃已收到的分片
    
  </details>
### 5.2.4 ICMPv4
<details><summary><font size="5"> ICMP内容 </summary>
  
-  type 3(Destination Unreachable)目标不可达
-  Type 11(Time exceeded)超时
-  Type 4 (Source Quench)源抑制
-  Type 5 (Redirect)重定向
-  Type 8 (Echo request)回声请求
-  Type 0 (Echo reply)回声响应

-  Type 13/14 (Timestamp)时间戳
   -  现在被NTP代替
-  Type 17/18 (Address Mask)地址掩码
   -  现在被DHCP代替
-  Type 9/10 (Router Solicit)路由公告
   - 现在IPv4由DHCP代替；IPv6由NDP代替
</details>
