### 5.6.1 路由协议的分类
> [自治系统](https://zh.wikipedia.org/wiki/%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F)是由同构型的网关连接的因特网，这样的系统往往就是由一个网络管理中心控制的。<br>
> 根据路由协议运行在内部或外部，可分为两种：
> - 运行于自治系统内部的[内部网关协议](https://zh.wikipedia.org/wiki/%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE)
> - 运行于自治系统外部的[外部网关协议](https://zh.wikipedia.org/wiki/%E5%A4%96%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE)

### 5.6.2 内部网关协议（IGP）
<details><summary><font size="5"> 路由信息协议 </summary>

> RIP的原型最早出现在[UNIX Berkley 4.3 BSD](https://zh.wikipedia.org/wiki/BSD)中，他采用[Bellman-Ford](https://zh.wikipedia.org/wiki/%E8%B4%9D%E5%B0%94%E6%9B%BC-%E7%A6%8F%E7%89%B9%E7%AE%97%E6%B3%95)的距离矢量路由算法，用于在[ARPANET](https://zh.wikipedia.org/wiki/ARPANET)中计算最佳路由<br>
> 适用于小型网络，因为它允许步数不超过15步

  <details><summary><font size="7"> 1）RIPv1 </summary>

**特点**：
> - **度量标准**：仅以跳数作为路径选择依据，最大有效跳数为15，16跳表示不可达
> - **更新方式**：定期（30秒）广播整个路由表到所有激活的接口（使用广播地址255.255.255.255），不关心邻居是否存在
> - **路由度量**：默认等价路径支持6条，但无法根据带宽、延迟等动态选路

**局限性**：
> - **不支持VLSM/CIDR**：由于路由更新中不携带子网掩码，无法支持可变长子网掩码和无类域间路由，必须使用主类网络（A、B、C类）
> - **收敛慢**：依赖计时器（更新30s、无效180s、刷新240s）来检测网络变化，容易产生路由环路
> - **无安全性**：不提供任何认证机制，易受恶意路由欺骗
  </details>

  <details><summary><font size="7"> 2）RIPv2 </summary>

**特点**
> - **度量标准**：依然以**跳数**为准，最大15跳，16跳不可达（与v1一致）
> - **更新方式**：使用[组播](https://zh.wikipedia.org/wiki/%E5%A4%9A%E6%92%AD)发送更新，而非广播，减少了对无关主机的干扰
> - **关键升级点**：路由更新中携带子网掩码，因此支持[VLSM](https://github.com/navi0231/network-engineer-note/blob/main/5-Internet-connection/5.2-IP-protocol.md#522--ipv4%E5%9C%B0%E5%9D%80)和[CIDR](https://zh.wikipedia.org/wiki/%E6%97%A0%E7%B1%BB%E5%88%AB%E5%9F%9F%E9%97%B4%E8%B7%AF%E7%94%B1)

**核心内容**：
> - **支持认证**：提供了**明文认证**和[**MD5认证**](https://zh.wikipedia.org/wiki/MD5)两种机制，增强了协议安全性，防止恶意路由注入。
> - **路由标记**：支持**路由标记（Tag）** 功能，可在路由策略中实现灵活控制（如区分内部路由和重分发进来的外部路由）。
> - **下一跳指示**：可以在更新中明确指定下一跳IP地址，在某些非广播多路访问网络中可优化路由路径。
  </details>

  <details><summary><font size="7"> 3）路由收敛和水平分割 </summary>

- ***路由环路（Routing Loops）***
  - 距离矢量算法要求相邻路由器周期性交换路由表。若不加限制，当网络发生故障时，可能导致各路由器对网络可达性认识不一致，使数据包在路由器之间来回传递，形成环路
- ***水平分割（Split Horizon）***
  - **核心规则**：路由器必须有选择地将路由表信息发送给邻居，而不是发送整个路由表。*一条路由信息不会被发送给该信息的来源*（即：不向信息的来源接口向外发送）
  - **作用**：通过避免向来源通告路由，消除两个节点之间形成环路的可能性
- ***毒性逆转（Split Horizon with Poisoned Reverse）***
  - **核心规则**：从邻居学习到的路由，在向该邻居发回更新时，将路由费用（Metric）设置为无限大
  - **优势**：比简单的水平分割更安全，*它可以立即中断环路的形成*。而简单水平分割方案必须等待一个更新周期才能中断环路
- ***触发更新（Triggered Updates）***
  - **定义**：不等待更新周期，在检测到网络故障时立即发送更新报文
  - **作用**：如果触发更新足够及时，可以在邻居收到错误的周期性更新之前告知故障，防止环路形成
  </details>

  <details><summary><font size="7"> 4）RIP报文格式 </summary>

> RIP报文封装在UDP数据报中发送，占用端口520

| 字节偏移 | 字段           | 长度   | 说明                   |
|----------|----------------|--------|-------------------------------|
| 0        | 命令           | 1字节  | 1=请求，2=响应                |
| 1        | 版本           | 1字节  | 1=RIPv1，2=RIPv2              |
| 2-3      | 未使用（必须为0）| 2字节 | 保留字段，必须填0             |
| 4-5      | 地址族标识符   | 2字节  | 2表示IP；0xFFFF表示认证项      |
| 6-7      | 路由标记       | 2字节  | 外部路由标记（如AS号）        |
| 8-11     | IP地址         | 4字节  | 目的网络地址                  |
| 12-15    | 子网掩码       | 4字节  | RIPv2使用，RIPv1填0           |
| 16-19    | 下一跳地址     | 4字节  | RIPv2使用，RIPv1无意义        |
| 20-23    | 距离           | 4字节  | 度量值，1~15有效，16不可达    |

|字段|解释|
|---|---|
|命令|1表示请求报文，2表示响应报文|
|版本|1表示RIPv1，2表示RIPv2|
|地址族标识符|对于IP协议，该字段为2；RIPv2中若为0xFFFF则表示当前条目用于认证|
|路由标记|用于区分内部路由和外部路由（通常用16位AS编号标记从其他自治系统引入的路由）|
|IP地址|目的网络地址|
|子网掩码|RIPv2的关键改进，携带对应网络的子网掩码，实现VLSM/CIDR支持；RIPv1该字段为0|
|下一跳地址|指定比发送者更优的下一跳，优化路由选择（RIPv1无此字段）|
|距离|度量值，1~15有效，16表示不可达|

  </details>
