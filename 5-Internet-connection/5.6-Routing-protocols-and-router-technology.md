### 5.6.1 路由协议的分类
> [自治系统](https://zh.wikipedia.org/wiki/%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F)是由同构型的网关连接的因特网，这样的系统往往就是由一个网络管理中心控制的。<br>
> 根据路由协议运行在内部或外部，可分为两种：
> - 运行于自治系统内部的[内部网关协议](https://zh.wikipedia.org/wiki/%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE)
> - 运行于自治系统外部的[外部网关协议](https://zh.wikipedia.org/wiki/%E5%A4%96%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE)

### 5.6.2 内部网关协议（IGP）
<details><summary><font size="5"> 路由信息协议 </summary>

> RIP的原型最早出现在[UNIX Berkley 4.3 BSD](https://zh.wikipedia.org/wiki/BSD)中，他采用[Bellman-Ford](https://zh.wikipedia.org/wiki/%E8%B4%9D%E5%B0%94%E6%9B%BC-%E7%A6%8F%E7%89%B9%E7%AE%97%E6%B3%95)的距离矢量路由算法，用于在[ARPANET](https://zh.wikipedia.org/wiki/ARPANET)中计算最佳路由<br>
> 适用于小型网络，因为它允许步数不超过15步

  <details><summary><font size="7"> 1）RIPv1 </summary>

**特点**：
> - **度量标准**：仅以跳数作为路径选择依据，最大有效跳数为15，16跳表示不可达
> - **更新方式**：定期（30秒）广播整个路由表到所有激活的接口（使用广播地址255.255.255.255），不关心邻居是否存在
> - **路由度量**：默认等价路径支持6条，但无法根据带宽、延迟等动态选路

**局限性**：
> - **不支持VLSM/CIDR**：由于路由更新中不携带子网掩码，无法支持可变长子网掩码和无类域间路由，必须使用主类网络（A、B、C类）
> - **收敛慢**：依赖计时器（更新30s、无效180s、刷新240s）来检测网络变化，容易产生路由环路
> - **无安全性**：不提供任何认证机制，易受恶意路由欺骗
  </details>

  <details><summary><font size="7"> 2）RIPv2 </summary>

**特点**
> - **度量标准**：依然以**跳数**为准，最大15跳，16跳不可达（与v1一致）
> - **更新方式**：使用[组播](https://zh.wikipedia.org/wiki/%E5%A4%9A%E6%92%AD)发送更新，而非广播，减少了对无关主机的干扰
> - **关键升级点**：路由更新中携带子网掩码，因此支持[VLSM](https://github.com/navi0231/network-engineer-note/blob/main/5-Internet-connection/5.2-IP-protocol.md#522--ipv4%E5%9C%B0%E5%9D%80)和[CIDR](https://zh.wikipedia.org/wiki/%E6%97%A0%E7%B1%BB%E5%88%AB%E5%9F%9F%E9%97%B4%E8%B7%AF%E7%94%B1)

**核心内容**：
> - **支持认证**：提供了**明文认证**和[**MD5认证**](https://zh.wikipedia.org/wiki/MD5)两种机制，增强了协议安全性，防止恶意路由注入。
> - **路由标记**：支持**路由标记（Tag）** 功能，可在路由策略中实现灵活控制（如区分内部路由和重分发进来的外部路由）。
> - **下一跳指示**：可以在更新中明确指定下一跳IP地址，在某些非广播多路访问网络中可优化路由路径。
  </details>

  <details><summary><font size="7"> 3）路由收敛和水平分割 </summary>

- ***路由环路（Routing Loops）***
  - 距离矢量算法要求相邻路由器周期性交换路由表。若不加限制，当网络发生故障时，可能导致各路由器对网络可达性认识不一致，使数据包在路由器之间来回传递，形成环路
- ***水平分割（Split Horizon）***
  - **核心规则**：路由器必须有选择地将路由表信息发送给邻居，而不是发送整个路由表。*一条路由信息不会被发送给该信息的来源*（即：不向信息的来源接口向外发送）
  - **作用**：通过避免向来源通告路由，消除两个节点之间形成环路的可能性
- ***毒性逆转（Split Horizon with Poisoned Reverse）***
  - **核心规则**：从邻居学习到的路由，在向该邻居发回更新时，将路由费用（Metric）设置为无限大
  - **优势**：比简单的水平分割更安全，*它可以立即中断环路的形成*。而简单水平分割方案必须等待一个更新周期才能中断环路
- ***触发更新（Triggered Updates）***
  - **定义**：不等待更新周期，在检测到网络故障时立即发送更新报文
  - **作用**：如果触发更新足够及时，可以在邻居收到错误的周期性更新之前告知故障，防止环路形成
  </details>

  <details><summary><font size="7"> 4）RIP报文格式 </summary>

> RIP报文封装在UDP数据报中发送，占用端口520

| 字节偏移 | 字段 | 长度 | 说明 |
|---|---|---|---|
| **头部**|**4字节**|
| 0 | 命令 | 1字节 | 1=请求报文，2=响应报文 |
| 1 | 版本  | 1字节  | 2（RIPv2） |
| 2-3 | 未使用（必须为0）| 2字节 | *保留字段，必须填0* |
| **第一个路由记录**|**20字节** | | |
| 4-5 | 地址族标识符 | 2字节 | 2表示IP协议；**0xFFFF表示此项用于认证** |
| 6-7 | 路由标记 | 2字节 | 用于区分内部路由和外部路由<br>（如携带AS号）|
| 8-11 | 网络地址 | 4字节 | 目的IP地址 |
| 12-15 | 子网掩码 | 4字节 | 对应网络地址的子网掩码（RIPv2关键改进）|
| 16-19 | 下一跳路由器地址 | 4字节 | 可指定比发送者更优的下一跳|
| 20-23| 距离 | 4字节 | 度量值（跳数），1~15有效，16表示不可达|

|字段|解释|
|---|---|
|命令|1表示请求报文，2表示响应报文|
|版本|1表示RIPv1，2表示RIPv2|
|地址族标识符|对于IP协议，该字段为2；RIPv2中若为0xFFFF则表示当前条目用于认证|
|路由标记|用于区分内部路由和外部路由（通常用16位AS编号标记从其他自治系统引入的路由）|
|IP地址|目的网络地址|
|子网掩码|RIPv2的关键改进，携带对应网络的子网掩码，实现VLSM/CIDR支持；RIPv1该字段为0|
|下一跳地址|指定比发送者更优的下一跳，优化路由选择（RIPv1无此字段）|
|距离|度量值，1~15有效，16表示不可达|

  </details>
</details>

<details><summary><font size="5"> 2.RIPng </summary>

- RIPng（Routing Information Protocol next generation）在[RFC 2080](https://datatracker.ietf.org/doc/html/rfc2080)中被定义，主要是针对IPv6做一些延伸的规范。与RIPv2相比下其最主要的差异是：
  - RIPv2 支持RIP更新认证, RIPng 不支持，因为IPv6路由器依赖[IPsec](https://en.wikipedia.org/wiki/IPsec)来进行身份验证
  - RIPv2 在**每个**路由表项中都保存下一跳的信息，RIPng 是对**一组**路由表项指定下一跳信息
  - RIPv2 使用UDP端口*520*和多播地址*224.0.0.9*通信，RIPng 则使用UDP端口*521*和多播地址*FF02::9*通信
</details>

<details><summary><font size="5"> 3.OSPF协议 </summary>

> [OSPF（开放最短路径优先）](https://www.ietf.org/rfc/rfc2328.txt)是一种[链路状态](https://zh.wikipedia.org/wiki/%25E9%2593%25BE%25E8%25B7%25AF%25E7%258A%25B6%25E6%2580%2581%25E9%2580%259A%25E5%2591%258A)内部网关协议，用于在单一[自治系统](https://zh.wikipedia.org/wiki/%25E8%2587%25AA%25E6%25B2%25BB%25E7%25B3%25BB%25E7%25BB%259F)内部交换路由信息。它与[距离矢量协议](https://zh.wikipedia.org/wiki/%25E8%25B7%259D%25E9%259B%25A2%25E5%2590%2591%25E9%2587%258F%25E8%25B7%25AF%25E7%2594%25B1%25E5%258D%2594%25E5%25AE%259A)（如RIP）有本质不同，具有**收敛快**、**支持大型网络**、**无环路**等特点。

  <details><summary><font size="7"> 1）OSPF区域 </summary>

| 区域类型 | 核心特点 | 允许的[LSA](https://zh.wikipedia.org/wiki/%E9%93%BE%E8%B7%AF%E7%8A%B6%E6%80%81%E9%80%9A%E5%91%8A) | 不允许的LSA | 默认路由 |
|---|---|---|---|---|
| **骨干区域<br>（Area 0）**| OSPF的核心枢纽，所有非骨干区域必须直接或逻辑连接到Area 0，负责区域间路由汇总和传递 |所有LSA<br>(Type-1~5)| 无 | 无 |
| **标准区域** | 可接收任何链路更新信息和路由汇总信息 | 所有LSA<br>(Type-1~5) | 无 | 无 |
| **末节区域<br>（Stub区域）** | 不允许AS外部引入的LSA，区域内路由器无法学习外部路由，对外部目标默认走ABR | Type-1/2/3 | Type-4/5 | ABR自动下发默认路由 |
| **完全末节区域<br>（Totally Stub区域）** | 在Stub基础上，不再接收域间路由信息（Type-3 LSA无法泛洪），只保留区域内LSA和ABR下发的[缺省LSA](https://support.huawei.com/enterprise/en/doc/EDOC1000175918/4d1f43e2/ospf-default-route-overview) | Type-1/2 + Type-3缺省 | Type-3（非缺省）、Type-4/5 | ABR下发Type-3缺省LSA |
| **非纯末节区域<br>（NSSA区域）** | Stub区域有引入外部路由需求时使用，用Type-7 LSA描述引入的外部路由 | Type-1/2/3 + Type-7 | Type-4/5 | 需手动配置或由ABR下发 |
| **完全非纯末节区域<br>（Totally NSSA区域）** | 在NSSA基础上，不再接收Type-3 LSA，保留NSSA其他特性 | Type-1/2 + Type-7 | Type-3、Type-4/5 | 需手动配置或由ABR下发 |

  </details>

  <details><summary><font size="7"> 2）OSPF类型 </summary>

| 网络类型 | 数据链路层协议（典型） | DR/BDR选举 | 通信方式 | 特点与适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **点对点网络**<br>（Point-to-Point，P2P） | **[PPP](https://zh.wikipedia.org/wiki/%E7%82%B9%E5%AF%B9%E7%82%B9%E5%8D%8F%E8%AE%AE)、[HDLC](https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E6%8E%A7%E5%88%B6)** | **不需要** | 组播发送 | 两个路由器直接相连，无需选举DR，建立邻接关系简单、快速。常见于广域网串行链路。 |
| **广播型网络**<br>（Broadcast） | **以太网（Ethernet）**|**局域网（Regional network）** | **需要** | 组播发送<br>（224.0.0.5/6） | 多路访问环境中，通过选举DR/BDR来减少邻接关系数量和LSA泛洪 |
| **非广播多路访问网络**<br>（NBMA） | **帧中继、ATM、X.25** | **需要** | 单播发送 | 物理上多路访问，但不支持广播/组播。需手动配置邻居，选举DR/BDR。典型场景：传统广域网。 |
| **点对多点网络**<br>（Point-to-MultiPoint，P2MP） | **（通常是NBMA的变种）** | **不需要** | 组播或单播 | 将NBMA网络模拟成一组点对点链路，无需选举DR/BDR，自动生成主机路由。适用于部分互联的NBMA环境。 |

  </details>

  <details><summary><font size="7"> 3）OSPF路由器 </summary>

| 类型 | 核心定义 | 位置与主要功能 | 备注 |
| :--- | :--- | :--- | :--- |
| **内部路由器（IR）** | 所有接口都属于**同一个OSPF区域**的路由器 | 仅维护所在区域的链路状态数据库（LSDB），运行[SPF算法](https://zh.wikipedia.org/wiki/%E6%88%B4%E5%85%8B%E6%96%AF%E7%89%B9%E6%8B%89%E7%AE%97%E6%B3%95)计算区域内路由 | 不与其他区域交换路由信息 |
| **骨干路由器（BR）** | 至少有一个接口属于**骨干区域（Area 0）** 的路由器 | 负责在骨干区域内维护LSDB，并连接其他区域（通过ABR） | 包括所有接口在Area 0的内部路由器，以及连接了Area 0和其他区域的ABR |
| **区域边界路由器（ABR）** | 同时连接**骨干区域（Area 0）** 和**其他非骨干区域**的路由器 | 为所连接的每个区域维护独立的LSDB，负责在区域间传播路由信息（生成Type-3、Type-4 LSA），并将非骨干区域的路由汇总后通告到骨干区域。 | OSPF的核心角色，必须至少有一个接口在Area 0 |
| **自治系统边界路由器（ASBR）** | 将**外部路由**（来自其他路由协议或静态路由）**引入（重分发）** 到OSPF网络中的路由器 | 生成Type-5 LSA（外部LSA）或Type-7 LSA（NSSA区域外部LSA），向整个OSPF自治系统通告外部网络信息 | 可以是内部路由器、ABR或骨干路由器，只要引入了外部路由即成为ASBR |

  <details><summary><font size="7"> 4）链路状态公告（LSA） </summary>

| 类型 | 名称 | 发布者 | 描述 | 学习资源 |
| :--- | :--- | :--- | :--- | :--- |
| **Type-1** | 路由器LSA | 每台路由器 | 描述区域内路由器的接口状态、链路信息及开销。 | [视频](https://zh.wikipedia.org/wiki/File:2_1_router_lsa_cn.ogv) |
| **Type-2** | 网络LSA | **DR**（指定路由器） | 描述广播网络（如以太网）中所有与之相连的路由器。 | [视频](https://zh.wikipedia.org/wiki/File:2_2_network_lsa_cn.ogv) |
| **Type-3** | 网络汇总LSA | **ABR** | 描述本区域到其他区域的路由信息（即区域间路由）。 | [视频](https://zh.wikipedia.org/wiki/File:2_3_network_summary_cn.ogv) |
| **Type-4** | ASBR汇总LSA | **ABR** | 描述本区域到其他区域的ASBR（自治系统边界路由器）的连接关系，告诉其他路由器如何到达ASBR。 | [视频](https://zh.wikipedia.org/wiki/File:2_4_ASBR_Summary_lsa_cn.ogv) |
| **Type-5** | 外部LSA | **ASBR** | 描述自治系统外部的路由（即从其他路由协议引入的默认路由或具体路由），在整个AS内泛洪。 | [视频](https://zh.wikipedia.org/wiki/File:2_5_AS_External_lsa_cn.ogv) |
| **Type-7** | NSSA外部LSA | **ASBR（在NSSA内）** | NSSA区域专用，描述引入的外部路由。它仅在NSSA区域内泛洪，到达ABR后会被转换为Type-5 LSA，再传播到其他区域。 | （文字说明） |
  </details>
